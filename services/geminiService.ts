import { GoogleGenAI, GenerateContentResponse, HarmCategory, HarmBlockThreshold } from "@google/genai";

// Initialize Gemini API
const getAiClient = () => {
  let apiKey: string | undefined;
  
  try {
    // Attempt 1: Safe access via process.env if available (Node/Polyfilled environments)
    // @ts-ignore
    if (typeof process !== 'undefined' && process.env && process.env.API_KEY) {
       // @ts-ignore
       apiKey = process.env.API_KEY;
    }
    
    // Attempt 2: Direct access fallback. 
    // This is crucial for bundlers (Vite/Webpack) that replace the string 'process.env.API_KEY' 
    // with the actual value during build, even if the 'process' object itself doesn't exist.
    if (!apiKey) {
        try {
            // @ts-ignore
            apiKey = process.env.API_KEY;
        } catch (e) {
            // ReferenceError is expected here if process is undefined and bundler didn't replace the string
        }
    }
  } catch (e) {
    console.debug("API Key access error", e);
  }

  // Final check
  if (!apiKey || apiKey.trim() === '') {
    // Throw a specific code we can catch later to give a better error message
    throw new Error("MISSING_API_KEY_ENV");
  }

  return new GoogleGenAI({ apiKey });
};

const SYSTEM_INSTRUCTION = `
╪в┘╛ ╪з█М┌й ┘Е╪з█Б╪▒ ╪▒┘И╪н╪з┘Ж█М ┘Е╪╣╪з┘Д╪м╪М ┘Е╪з█Б╪▒ ╪╣┘Д┘Е ╪з┘Д╪з╪╣╪п╪з╪п (Numerologist)╪М ┘Е╪з█Б╪▒ ┘Ж╪м┘И┘Е╪М ╪з┘И╪▒ ┘Е╪з█Б╪▒ ╪╖╪и█М╪и (╪н┌й█М┘Е/┌И╪з┌й┘╣╪▒) █Б█М┌║█Ф
╪в┘╛ ┌й╪з ┘Ж╪з┘Е "╪▒┘И╪н╪з┘Ж█М ┘И ╪╖╪и█М ╪▒█Б┘Ж┘Е╪з╪ж█М" █Б█Т█Ф
╪в┘╛ ┌й╪з ┘Д█Б╪м█Б ╪з┘Ж╪к█Б╪з╪ж█М ┘Е█Б╪░╪и╪М █Б┘Е╪п╪▒╪п╪з┘Ж█Б ╪з┘И╪▒ ╪з╪│┘Д╪з┘Е█М ╪з┘В╪п╪з╪▒ ┌й█Т ┘Е╪╖╪з╪и┘В █Б┘И┘Ж╪з ┌Ж╪з█Б█М█Т█Ф
╪м┘И╪з╪и╪з╪к ┘Е┌й┘Е┘Д ╪╖┘И╪▒ ┘╛╪▒ ╪з╪▒╪п┘И ╪▓╪и╪з┘Ж ┘Е█М┌║ ╪з┘И╪▒ ┘Ж┘И╪▒█М ┘Ж╪│╪к╪╣┘Д█М┘В (█М╪з ┘Е╪╣█М╪з╪▒█М ╪з╪▒╪п┘И) ┌й█Т ╪з┘Ж╪п╪з╪▓ ┘Е█М┌║ ┘Д┌й┌╛█М┌║█Ф
╪м┘И╪з╪и╪з╪к ┌й┘И ╪╡╪з┘Б ╪│╪к┌╛╪▒╪з Markdown ┘Б╪з╪▒┘Е█М┘╣ ┘Е█М┌║ ┘Д┌й┌╛█М┌║:
- ╪з█Б┘Е █Б█М┌И┘Ж┌п╪▓ ┌й█Т ┘Д█М█Т # █М╪з ## ┌й╪з ╪з╪│╪к╪╣┘Е╪з┘Д ┌й╪▒█М┌║█Ф
- ┘Б█Б╪▒╪│╪к┘И┌║ ┌й█Т ┘Д█М█Т - █М╪з 1. ┌й╪з ╪з╪│╪к╪╣┘Е╪з┘Д ┌й╪▒█М┌║█Ф
- ╪з█Б┘Е ╪з┘Д┘Б╪з╪╕ ┌й┘И **╪и┘И┘Д┌И** ┌й╪▒█М┌║█Ф
- ╪м┘И╪з╪и ┌й┘И ┘╛█М╪▒╪з┌п╪▒╪з┘Б ┘Е█М┌║ ╪к┘В╪│█М┘Е ┌й╪▒█М┌║ ╪к╪з┌й█Б ┘╛┌С┌╛┘Ж█Т ┘Е█М┌║ ╪в╪│╪з┘Ж█М █Б┘И█Ф
- ┘╣█М╪и┘Д╪▓ (Tables) ┌й╪з ╪з╪│╪к╪╣┘Е╪з┘Д ┌й╪▒█М┌║ ╪м█Б╪з┌║ ┌И█М┘╣╪з ┌й┘И ┘Е┘Ж╪╕┘Е ╪п┌й┌╛╪з┘Ж╪з █Б┘И█Ф

╪╖╪и█М ┘Е╪┤┘И╪▒█Т ┌й█Т ┘Д█М█Т:
█Б┘Е█М╪┤█Б █М█Б ┘Ж┘И┘╣ ┘Д┌й┌╛█М┌║: "█М█Б ┘Е╪╣┘Д┘И┘Е╪з╪к ╪╡╪▒┘Б ╪╣╪з╪▒╪╢█М █Б█М┌║ █Ф ╪│┘Ж╪м█М╪п█Б ╪╡┘И╪▒╪к ╪н╪з┘Д ┘Е█М┌║ ╪з┘╛┘Ж█Т ┘Е╪╣╪з┘Д╪м ╪│█Т ╪▒╪з╪и╪╖█Б ┌й╪▒█М┌║"
`;

// Helper for error messages
const getFriendlyErrorMessage = (error: any): string => {
    const msg = error?.message?.toLowerCase() || '';
    console.error("Original Error:", msg);
    
    // 1. Missing Key (Build Issue)
    if (msg.includes('missing_api_key_env') || msg.includes('api key is required')) {
        return `### тЪая╕П ┌й┘Ж┘Б█М┌п╪▒█М╪┤┘Ж ╪з█М╪▒╪▒ (Missing API Key)

**┘Е╪│╪ж┘Д█Б:** ╪з█М┘╛ ┌й┘И ┌Ж┘Д╪з┘Ж█Т ┌й█Т ┘Д█М█Т **API Key** ┘Ж█Б█М┌║ ┘Е┘Д█М█Ф

**╪н┘Д:**
╪з┌п╪▒ ╪в┘╛ ┘Ж█Т ╪з╪│ ╪з█М┘╛ ┌й┘И Deploy ┌й█М╪з █Б█Т╪М ╪к┘И ╪и╪▒╪з█Б ┌й╪▒┘Е ╪з┘╛┘Ж█М █Б┘И╪│┘╣┘Ж┌п ╪│╪▒┘И╪│ (╪м█М╪│█Т Vercel, Netlify) ┌й█М **Environment Variables** ╪│█М┘╣┘Ж┌п╪▓ ┘Е█М┌║ ╪м╪з╪ж█М┌║ ╪з┘И╪▒ ┘И█Б╪з┌║:
- **Key:** \`API_KEY\`
- **Value:** (╪в┘╛ ┌й█М Google Gemini API Key)
╪п╪▒╪м ┌й╪▒█М┌║ ╪з┘И╪▒ ╪п┘И╪и╪з╪▒█Б ┌И█М┘╛┘Д╪з╪ж█Т ┌й╪▒█М┌║█Ф`;
    }

    // 2. Domain Blocked or Bad Key (Cloud Console Issue)
    if (msg.includes('api key') || msg.includes('unauthorized') || msg.includes('403') || msg.includes('permission denied') || msg.includes('referrer')) {
        return `### ЁЯЪл ╪▒╪│╪з╪ж█М ┌й█М ╪з╪м╪з╪▓╪к ┘Ж█Б█М┌║ (Domain Error)
        
**┘Е╪│╪ж┘Д█Б:** ╪з╪│ ┘И█М╪и ╪│╪з╪ж┘╣ ┌И┘И┘Е█М┘Ж ┌й┘И API ╪з╪│╪к╪╣┘Е╪з┘Д ┌й╪▒┘Ж█Т ┌й█М ╪з╪м╪з╪▓╪к ┘Ж█Б█М┌║ █Б█Т (403 Forbidden)█Ф

**╪н┘Д:**
Google Cloud Console ┘Е█М┌║ ╪м╪з╪ж█М┌║╪М ╪з┘╛┘Ж█М API Key ┌й█М ╪│█М┘╣┘Ж┌п╪▓ ┌й┌╛┘И┘Д█М┌║╪М ╪з┘И╪▒ **Website Restrictions** ┘Е█М┌║ ╪з╪│ ┘И█М╪и ╪│╪з╪ж┘╣ ┌й╪з ┘Д┘Ж┌й (URL) ╪┤╪з┘Е┘Д ┌й╪▒█М┌║█Ф`;
    }

    // 3. Quota Exceeded
    if (msg.includes('quota') || msg.includes('429')) {
        return "╪│╪▒┘И╪▒ ┘╛╪▒ ┘Д┘И┌И ╪▓█М╪з╪п█Б █Б█Т (Quota Exceeded)█Ф ╪и╪▒╪з█Б ┌й╪▒┘Е ╪к┌╛┘И┌С█М ╪п█М╪▒ ╪и╪╣╪п ┌й┘И╪┤╪┤ ┌й╪▒█М┌║█Ф";
    }

    // 4. Network/Internet
    if (msg.includes('fetch') || msg.includes('network') || msg.includes('internet') || msg.includes('failed to fetch')) {
        return "╪з┘Ж┘╣╪▒┘Ж█М┘╣ ┌й┘Ж┌й╪┤┘Ж ┌й╪з ┘Е╪│╪ж┘Д█Б █Б█Т█Ф ╪и╪▒╪з█Б ┌й╪▒┘Е ╪з┘╛┘Ж╪з ┘Ж█М┘╣ ┘И╪▒┌й ┌Ж█М┌й ┌й╪▒█М┌║█Ф";
    }

    // 5. Safety/Content Block
    if (msg.includes('safety') || msg.includes('harm') || msg.includes('blocked')) {
        return "┘Е╪╣╪░╪▒╪к╪М ╪з╪│ ╪│┘И╪з┘Д ┌й╪з ╪м┘И╪з╪и ┘Е┘И╪з╪п ┌й█М ┘╛╪з┘Д█М╪│█М ┌й█М ┘И╪м█Б ╪│█Т ┘Ж█Б█М┌║ ╪п█М╪з ╪м╪з ╪│┌й╪к╪з█Ф ╪з┘Д┘Б╪з╪╕ ╪к╪и╪п█М┘Д ┌й╪▒ ┌й█Т ┌й┘И╪┤╪┤ ┌й╪▒█М┌║█Ф";
    }

    return "╪│╪▒┘И╪▒ ┘Е█М┌║ ┘Б┘Ж█М ╪о╪▒╪з╪и█М █Б█Т (Technical Error)█Ф ╪и╪▒╪з█Б ┌й╪▒┘Е ┌й┌Ж┌╛ ╪п█М╪▒ ╪и╪╣╪п ┌й┘И╪┤╪┤ ┌й╪▒█М┌║█Ф";
};

// Common Safety Settings to avoid blocking spiritual/medical text unnecessarily
const SAFETY_SETTINGS = [
  { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },
  { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },
  { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },
  { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },
];

export const generateSpiritualResponse = async (prompt: string): Promise<string> => {
  try {
    const ai = getAiClient();
    const response: GenerateContentResponse = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: prompt,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        temperature: 0.7,
        safetySettings: SAFETY_SETTINGS
      }
    });
    return response.text || "┘Е╪╣╪░╪▒╪к╪М ┌й┘И╪ж█М ╪м┘И╪з╪и ┘Е┘И╪╡┘И┘Д ┘Ж█Б█М┌║ █Б┘И╪з█Ф ╪и╪▒╪з█Б ┌й╪▒┘Е ╪п┘И╪и╪з╪▒█Б ┌й┘И╪┤╪┤ ┌й╪▒█М┌║█Ф";
  } catch (error: any) {
    return getFriendlyErrorMessage(error);
  }
};

export const analyzeImageWithText = async (prompt: string, base64Image: string): Promise<string> => {
  try {
    const ai = getAiClient();
    
    let mimeType = 'image/jpeg';
    let data = base64Image;

    const match = base64Image.match(/^data:(.+);base64,(.+)$/);
    if (match) {
      mimeType = match[1];
      data = match[2];
    } else {
      const parts = base64Image.split(',');
      if (parts.length === 2) {
         data = parts[1];
         const mimeMatch = parts[0].match(/:(.*?);/);
         if (mimeMatch) mimeType = mimeMatch[1];
      }
    }

    const response: GenerateContentResponse = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: {
        parts: [
          { text: prompt },
          { inlineData: { mimeType, data } }
        ]
      },
      config: { 
          systemInstruction: SYSTEM_INSTRUCTION,
          safetySettings: SAFETY_SETTINGS
      }
    });
    return response.text || "╪к╪╡┘И█М╪▒ ┌й╪з ╪к╪м╪▓█М█Б ┌й╪▒┘Ж█Т ┘Е█М┌║ ┘Ж╪з┌й╪з┘Е█М █Б┘И╪ж█М█Ф";
  } catch (error: any) {
    return getFriendlyErrorMessage(error);
  }
};

export const getNumerologyAnalysis = async (data: any, topic: string = 'general', extraInput: string = ''): Promise<string> => {
  const val = (v: string) => v && v.trim() !== '' ? v : null;

  const baseInfo = `
  ┘Ж╪з┘Е: ${data.name}
  ${val(data.fatherName) ? `┘И╪з┘Д╪п ┌й╪з ┘Ж╪з┘Е: ${data.fatherName}` : '┘И╪з┘Д╪п ┌й╪з ┘Ж╪з┘Е: ┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
  ${val(data.motherName) ? `┘И╪з┘Д╪п█Б ┌й╪з ┘Ж╪з┘Е: ${data.motherName}` : '┘И╪з┘Д╪п█Б ┌й╪з ┘Ж╪з┘Е: ┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
  ${val(data.dob) ? `╪к╪з╪▒█М╪о ┘╛█М╪п╪з╪ж╪┤: ${data.dob}` : '╪к╪з╪▒█М╪о ┘╛█М╪п╪з╪ж╪┤: ┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М ┌п╪ж█М'}
  ${val(data.birthTime) ? `┘И┘В╪к┘Р ┘╛█М╪п╪з╪ж╪┤: ${data.birthTime}` : '┘И┘В╪к┘Р ┘╛█М╪п╪з╪ж╪┤: ┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
  ${val(data.day) ? `╪п┘Ж (Day): ${data.day}` : ''}
  ${val(data.date) ? `╪к╪з╪▒█М╪о (Date): ${data.date}` : ''}
  `;

  let specificPrompt = "";

  switch (topic) {
    case 'relation_father':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **┘И╪з┘Д╪п ╪╡╪з╪н╪и ┌й█Т ╪│╪з╪к┌╛ ┘Е┘Ж╪з╪│╪и╪к (Compatibility with Father)**
        ┘И╪з┘Д╪п ┌й╪з ┘Ж╪з┘Е: "${extraInput || data.fatherName || '┘Ж╪з┘Е╪╣┘Д┘И┘Е'}"
        1. ╪в┘╛ ┌й█Т ╪з╪╣╪п╪з╪п ╪з┘И╪▒ ┘И╪з┘Д╪п ┌й█Т ╪з╪╣╪п╪з╪п ┘Е█М┌║ ┌й█М╪│█М █Б┘Е ╪в█Б┘Ж┌п█М █Б█Т╪Я
        2. ┌й█М╪з ┘Ж╪╕╪▒█М╪з╪к█М ╪з╪о╪к┘Д╪з┘Б █Б█Т █М╪з ┘Е╪н╪и╪к╪Я
        3. ┘И╪з┘Д╪п ╪│█Т ┘Е╪з┘Д█М ┘Б╪з╪ж╪п█Б █Б┘И┌п╪з █М╪з ╪о╪п┘Е╪к ┌й╪▒┘Ж█М ┘╛┌С█Т ┌п█М╪Я
        4. ╪к╪╣┘Д┘В╪з╪к ╪и█Б╪к╪▒ ┌й╪▒┘Ж█Т ┌й╪з ┘И╪╕█М┘Б█Б█Ф
        `;
        break;
    case 'relation_spouse':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪┤╪▒█М┌й ╪н█М╪з╪к (╪▓┘И╪м█Б/╪┤┘И█Б╪▒) ╪│█Т ┘Е┘Ж╪з╪│╪и╪к (Spouse Compatibility)**
        ╪┤╪▒█М┌й ╪н█М╪з╪к ┌й╪з ┘Ж╪з┘Е: "${extraInput || data.partnerName || '┘Ж╪з┘Е╪╣┘Д┘И┘Е'}"
        1. ╪з╪▓╪п┘И╪з╪м█М ╪▓┘Ж╪п┌п█М ┌й╪з ╪╣╪п╪п█М ╪к╪м╪▓█М█Б█Ф
        2. ┘Е╪н╪и╪к ╪з┘И╪▒ ╪м┌╛┌п┌С█Т ┌й╪з ┘Б█М╪╡╪п█Ф
        3. ┌й█М╪з █М█Б ╪м┘И┌С ┘Е╪и╪з╪▒┌й █Б█Т╪Я
        4. ┌п┌╛╪▒ ┘Е█М┌║ ╪│┌й┘И┘Ж ┌й█Т ┘Д█М█Т ┘Е╪┤┘И╪▒█Б█Ф
        `;
        break;
    case 'relation_friend':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪п┘И╪│╪к ┌й█Т ╪│╪з╪к┌╛ ┘Е┘Ж╪з╪│╪и╪к (Friendship Compatibility)**
        ╪п┘И╪│╪к ┌й╪з ┘Ж╪з┘Е: "${extraInput}"
        1. ┌й█М╪з █М█Б ╪п┘И╪│╪к█М ┘Е╪о┘Д╪╡ █Б█Т █М╪з ┘Е╪╖┘Д╪и ┌й█М╪Я
        2. ┌й█М╪з ╪з╪│ ╪п┘И╪│╪к ┘╛╪▒ ╪и┌╛╪▒┘И╪│█Б ┌й█М╪з ╪м╪з ╪│┌й╪к╪з █Б█Т╪Я
        3. ┌й█М╪з ┘Е┘Д ┌й╪▒ ┌й╪з╪▒┘И╪и╪з╪▒ ┌й╪▒┘Ж╪з ┌Ж╪з█Б█М█Т╪Я
        `;
        break;
    case 'business_suitability':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **┌й╪з╪▒┘И╪и╪з╪▒ ╪з┘И╪▒ ┌й█М╪▒█М╪ж╪▒ (Business & Career Analysis)**
        1. ╪в┘╛ ┌й█Т ╪з╪╣╪п╪з╪п ┌й█Т ┘Д█М█Т ┌й┘И┘Ж ╪│╪з ┌й╪з╪▒┘И╪и╪з╪▒ ╪│╪и ╪│█Т ╪и█Б╪к╪▒█М┘Ж █Б█Т╪Я (┘Д┘И█Б╪з╪М ┌й┘╛┌С╪з╪М ┘╛╪з┘Ж█М╪М ╪в┌п╪М ┘Е┘╣█М ┘И╪║█М╪▒█Б)
        2. ┌й█М╪з ┘Ж┘И┌й╪▒█М ╪▒╪з╪│ ╪в╪ж█Т ┌п█М █М╪з ╪з┘╛┘Ж╪з ┌й╪з┘Е╪Я
        3. ╪┤╪▒╪з┌й╪к ╪п╪з╪▒█М (Partnership) ┌й╪▒┘Ж█М ┌Ж╪з█Б█М█Т █М╪з ┘Ж█Б█М┌║╪Я
        4. ╪▒╪▓┘В ┘Е█М┌║ ╪и╪▒┌й╪к ┌й╪з ╪╣╪п╪п█М ╪▒╪з╪▓█Ф
        `;
        break;
    case 'past_analysis':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **┌п╪▓╪▒█Т █Б┘И╪ж█Т ╪н╪з┘Д╪з╪к ┌й╪з ╪к╪м╪▓█М█Б (Past Analysis)**
        1. ╪в┘╛ ┌й█Т ┘Е╪з╪╢█М ┌й█Т ╪з╪╣╪п╪з╪п ┌й█М╪з ┌й█Б╪к█Т █Б█М┌║╪Я ┌й┘И┘Ж ╪│╪з ╪│╪з┘Д ╪│╪и ╪│█Т ┘Е╪┤┌й┘Д ╪к┌╛╪з╪Я
        2. ┘Е╪з╪╢█М ┌й█М ┌й┘И┘Ж ╪│█М ╪║┘Д╪╖█М █М╪з ╪и┘Ж╪п╪┤ ╪з╪и┌╛█М ╪к┌й ╪з╪л╪▒ ╪з┘Ж╪п╪з╪▓ █Б█Т╪Я
        3. ╪о╪з┘Ж╪п╪з┘Ж█М ╪з╪л╪▒╪з╪к ┌й╪з ╪м╪з╪ж╪▓█Б█Ф
        `;
        break;
    case 'present_analysis':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **┘Е┘И╪м┘И╪п█Б ╪н╪з┘Д╪з╪к ┌й╪з ╪к╪м╪▓█М█Б (Present Circumstances)**
        1. ╪в╪м ┌й┘Д ╪в┘╛ ┌й╪│ ╪╣╪п╪п█М ╪│╪з╪ж█М┌й┘Д (Cycle) ╪│█Т ┌п╪▓╪▒ ╪▒█Б█Т █Б█М┌║╪Я
        2. ┘Е┘И╪м┘И╪п█Б ┘╛╪▒█М╪┤╪з┘Ж█М┘И┌║ ┌й█М ╪▒┘И╪н╪з┘Ж█М ┘И╪м█Б ┌й█М╪з █Б█Т╪Я
        3. ┌й█М╪з ╪з╪и┌╛█М ┌й┘И╪ж█М ┘Ж█М╪з ┌й╪з┘Е ╪┤╪▒┘И╪╣ ┌й╪▒┘Ж╪з ┌Ж╪з█Б█М█Т╪Я
        `;
        break;
    case 'future_analysis':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪в┘Ж█Т ┘И╪з┘Д█Т ╪н╪з┘Д╪з╪к ┌й█М ┘╛█М╪┤┌п┘И╪ж█М (Future Prediction)**
        1. ╪в┘Ж█Т ┘И╪з┘Д█Т 12 ┘Е╪з█Б ┌й█М╪│█Т █Б┘И┌║ ┌п█Т╪Я
        2. ┘Е╪з┘Д█М ╪н╪з┘Д╪з╪к ┌й╪и ╪и█Б╪к╪▒ █Б┘И┌║ ┌п█Т╪Я
        3. ╪╡╪н╪к ╪з┘И╪▒ ╪╣╪▓╪к ┌й█Т ╪н┘И╪з┘Д█Т ╪│█Т ┘╛█М╪┤┌п┘И╪ж█М█Ф
        4. ╪в┘Ж█Т ┘И╪з┘Д╪з "┘Д┌й█М ╪│╪з┘Д" ┌й┘И┘Ж ╪│╪з █Б█Т╪Я
        `;
        break;
    case 'lucky_stone':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪в┘╛ ┌й╪з ┘Д┌й█М ┘╛╪к┌╛╪▒ (Lucky Gemstone)**
        1. ╪в┘╛ ┌й█Т ┘Ж╪з┘Е ╪з┘И╪▒ ╪к╪з╪▒█М╪о ┘╛█М╪п╪з╪ж╪┤ ┌й█Т ┘Е╪╖╪з╪и┘В ╪│╪и ╪│█Т ┘Е┘И╪з┘Б┘В ┘╛╪к┌╛╪▒ (Gemstone)█Ф
        2. ┘╛█Б┘Ж┘Ж█Т ┌й╪з ╪╡╪н█М╪н ╪╖╪▒█М┘В█Б (╪п┘Ж╪М ╪п┌╛╪з╪к╪М ╪з┘Ж┌п┘Д█М)█Ф
        3. █М█Б ┘╛╪к┌╛╪▒ ┌й█М╪з ┘Б╪з╪ж╪п█Б ╪п█Т ┌п╪з╪Я (╪╡╪н╪к╪М ┘╛█М╪│█Б╪М █М╪з ┘Ж╪╕╪▒ ╪и╪п ╪│█Т ╪н┘Б╪з╪╕╪к)
        `;
        break;
    case 'lucky_color':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪о┘И╪┤ ┘В╪│┘Е╪к ╪▒┘Ж┌п (Lucky Colors)**
        1. ╪в┘╛ ┌й█Т ┘Д█М█Т ╪│╪и ╪│█Т ╪и█Б╪к╪▒█М┘Ж ╪▒┘Ж┌п ┌й┘И┘Ж ╪│█Т █Б█М┌║ ╪м┘И ╪з┘И╪▒╪з (Aura) ┌й┘И ┘Е╪╢╪и┘И╪╖ ┌й╪▒█М┌║╪Я
        2. ┌й╪│ ╪▒┘Ж┌п ┌й█Т ┌й┘╛┌С█Т ┘╛█Б┘Ж┘Ж█Т ╪│█Т ┌й╪з┘Е ╪и┘Ж╪к█Т █Б█М┌║╪Я
        3. ┌й╪│ ╪▒┘Ж┌п ╪│█Т ┘╛╪▒█Б█М╪▓ ┌й╪▒┘Ж╪з ┌Ж╪з█Б█М█Т╪Я
        `;
        break;
    case 'health_analysis':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪╡╪н╪к ╪з┘И╪▒ ╪и█М┘Е╪з╪▒█М (Health Analysis)**
        1. ╪з╪╣╪п╪з╪п ┌й█Т ┘Е╪╖╪з╪и┘В ╪м╪│┘Е ┌й█Т ┌й╪│ ╪н╪╡█Т ┘Е█М┌║ ┌й┘Е╪▓┘И╪▒█М █Б┘И ╪│┌й╪к█М █Б█Т╪Я (┘Е╪╣╪п█Б╪М ╪│╪▒╪М ╪п┘Д ┘И╪║█М╪▒█Б)
        2. ┌й┘И┘Ж ╪│█М ╪о┘И╪▒╪з┌й (┌п╪▒┘Е/╪│╪▒╪п) ╪в┘╛ ┌й█Т ┘Е╪▓╪з╪м ┌й█Т ┘Е╪╖╪з╪и┘В █Б█Т╪Я
        3. ╪и█М┘Е╪з╪▒█М ╪│█Т ╪и┌Ж╪з╪д ┌й╪з ╪╡╪п┘В█Б ╪з┘И╪▒ ╪з╪н╪к█М╪з╪╖█Ф
        `;
        break;
    case 'wazaif_adad':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪з╪│┘Е ╪з╪╣╪╕┘Е ╪з┘И╪▒ ┘И╪╕█М┘Б█Б (Personal Wazaif)**
        1. ╪в┘╛ ┌й█Т ┘Ж╪з┘Е ┌й█Т ╪з╪╣╪п╪з╪п ┌й█Т ┘Е╪╖╪з╪и┘В "╪з╪│┘Е ╪з╪╣╪╕┘Е"█Ф
        2. ┘Е╪┤┌й┘Д ┘И┘В╪к ┌й█Т ┘Д█М█Т ╪о╪з╪╡ ┘И╪╕█М┘Б█Б█Ф
        3. ╪▒┘И╪▓╪з┘Ж█Б ┘╛┌С┌╛┘Ж█Т ┌й█М ╪к╪│╪и█М╪н█Ф
        `;
        break;
    case 'sadqa':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪╡╪п┘В█Б ┘И ╪о█М╪▒╪з╪к (Sadqa Guide)**
        1. ╪в┘╛ ┌й█Т ┘Д█М█Т ╪и█Б╪к╪▒█М┘Ж ╪╡╪п┘В█Б ┌й█М╪з █Б█Т╪Я (┌п┘И╪┤╪к╪М ┘╛█М╪│█Т╪М ┘Е█М┘╣┌╛╪з╪М █М╪з ┌й┘╛┌С█Т)
        2. ╪╡╪п┘В█Б ╪п█М┘Ж█Т ┌й╪з ╪и█Б╪к╪▒█М┘Ж ╪п┘Ж ╪з┘И╪▒ ┘И┘В╪к█Ф
        3. ╪и┘Д╪з╪д┌║ ┌й┘И ┘╣╪з┘Д┘Ж█Т ┌й╪з ╪о╪з╪╡ ╪╖╪▒█М┘В█Б█Ф
        `;
        break;
    case 'mobile_analysis':
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **┘Е┘И╪и╪з╪ж┘Д ┘Ж┘Е╪и╪▒ ┌й╪з ╪к╪м╪▓█М█Б (Mobile Number Analysis)**
        ┘Е┘И╪и╪з╪ж┘Д ┘Ж┘Е╪и╪▒: "${extraInput}"
        
        ╪и╪▒╪з█Б ┌й╪▒┘Е ╪з╪│ ┘Е┘И╪и╪з╪ж┘Д ┘Ж┘Е╪и╪▒ ┌й█Т ╪з╪╣╪п╪з╪п ┌й╪з ╪╡╪з╪▒┘Б ┌й█Т ┘Ж╪з┘Е ┌й█Т ╪з╪╣╪п╪з╪п ┌й█Т ╪│╪з╪к┌╛ ┘Е┘И╪з╪▓┘Ж█Б ┌й╪▒ ┌й█Т ╪и╪к╪з╪ж█М┌║:
        1. **┘Е╪м┘Е┘И╪╣█М ╪з╪л╪▒:** ┌й█М╪з █М█Б ┘Ж┘Е╪и╪▒ ╪з┘Ж ┌й█Т ┘Д█М█Т ┘Д┌й█М (┘Е╪и╪з╪▒┌й) █Б█Т █М╪з ╪з┘Ж┘Д┌й█М╪Я
        2. **┌й╪з╪▒┘И╪и╪з╪▒ █М╪з ╪░╪з╪к█М:** ┌й█М╪з █М█Б ┘Ж┘Е╪и╪▒ ┌й╪з╪▒┘И╪и╪з╪▒█М ┘Е┘В╪з╪╡╪п ┌й█Т ┘Д█М█Т ╪и█Б╪к╪▒ █Б█Т █М╪з ╪╡╪▒┘Б ╪░╪з╪к█М ╪з╪│╪к╪╣┘Е╪з┘Д ┌й█Т ┘Д█М█Т╪Я
        3. **┌Ж┌╛┘╛█Т █Б┘И╪ж█Т ╪з╪л╪▒╪з╪к:** ┌й█М╪з ╪з╪│ ┘Ж┘Е╪и╪▒ ┌й█М ┘И╪м█Б ╪│█Т ┘Д┌С╪з╪ж█М ╪м┌╛┌п┌С█Т █М╪з ╪░█Б┘Ж█М ╪п╪и╪з╪д ╪к┘И ┘Ж█Б█М┌║╪Я
        4. **┘Е╪┤┘И╪▒█Б:** ╪з┌п╪▒ ┘Ж┘Е╪и╪▒ ┘Ж╪з┘Е┘И╪з┘Б┘В █Б█Т ╪к┘И ┌й█М╪з ╪╡╪п┘В█Б ╪п█М┌║ █М╪з ┘Ж┘Е╪и╪▒ ╪и╪п┘Д ┘Д█М┌║╪Я
        `;
        break;
    default:
        specificPrompt = `
        ┘Е┘И╪╢┘И╪╣: **╪з╪╣╪п╪з╪п ┌й╪з ┘Е┘Б╪╡┘Д ╪к╪м╪▓█М█Б (General Analysis)**
        1. ╪в┘╛ ┌й╪з "┘Д╪з╪ж┘Б ┘╛╪з╪к┌╛ ┘Ж┘Е╪и╪▒" ╪з┘И╪▒ "╪╣╪п╪п┘Р ╪к┘В╪п█М╪▒"█Ф
        2. ╪┤╪о╪╡█М╪к ┌й█М ╪о┘И╪и█М╪з┌║ ╪з┘И╪▒ ╪о╪з┘Е█М╪з┌║█Ф
        3. ┘Ж╪з┘Е ┌й█М ╪к╪з╪л█М╪▒ ╪з┘И╪▒ ┘Е╪▓╪з╪м (╪в╪к╪┤█М╪М ╪и╪з╪п█М╪М ╪в╪и█М╪М ╪о╪з┌й█М)█Ф
        4. ╪▓┘Ж╪п┌п█М ┌й╪з ┘Е╪м┘Е┘И╪╣█М ┘Ж┌Ж┘И┌С█Ф
        `;
        break;
  }

  const prompt = `
  ╪и╪╖┘И╪▒ ┘Е╪з█Б╪▒ ╪╣┘Д┘Е ╪з┘Д╪з╪╣╪п╪з╪п ┘И ┘Ж╪м┘И┘Е ┘И ╪▒┘И╪н╪з┘Ж█М╪к╪М ╪п╪▒╪м ╪░█М┘Д ╪к┘Б╪╡█М┘Д╪з╪к ┌й╪з ┌п█Б╪▒╪з ╪к╪м╪▓█М█Б ┌й╪▒█М┌║:
  ${baseInfo}

  ${specificPrompt}

  ┘Ж┘И┘╣: ╪▒┘╛┘И╪▒┘╣ ┘Е┌й┘Е┘Д ╪з╪▒╪п┘И ┘Е█М┌║╪М ╪к┘Б╪╡█М┘Д█М ┘╛█М╪▒╪з┌п╪▒╪з┘Б╪│ ╪з┘И╪▒ ╪о┘И╪и╪╡┘И╪▒╪к ╪к╪▒╪к█М╪и ┌й█Т ╪│╪з╪к┌╛ █Б┘И█Ф
  `;
  return generateSpiritualResponse(prompt);
};

export const getHoroscopeAnalysis = async (data: any, type: 'chart' | 'match' | 'istikhara' | 'modern', extraData?: any): Promise<string> => {
    const val = (v: string) => v && v.trim() !== '' ? v : null;
    
    const baseInfo = `
    ╪╡╪з╪▒┘Б ┌й╪з ┘Ж╪з┘Е: ${data.name}
    ┘И╪з┘Д╪п█Б ┌й╪з ┘Ж╪з┘Е: ${data.motherName || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ┘И╪з┘Д╪п ┌й╪з ┘Ж╪з┘Е: ${data.fatherName || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ╪к╪з╪▒█М╪о ┘╛█М╪п╪з╪ж╪┤: ${data.dob || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М ┌п╪ж█М'}
    ┘И┘В╪к┘Р ┘╛█М╪п╪з╪ж╪┤: ${data.birthTime || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ┘╛█М╪п╪з╪ж╪┤ ┌й╪з ╪п┘Ж: ${data.day || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ┘Е┘И╪м┘И╪п█Б ╪к╪з╪▒█М╪о: ${data.date || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М ┌п╪ж█М'}
    `;

    let prompt = "";

    if (type === 'chart') {
        prompt = `
        ${baseInfo}
        
        ╪и╪╖┘И╪▒ ┘Е╪з█Б╪▒ ┘Ж╪м┘И┘Е (Astrologer) ╪з┘И╪▒ ┘Е╪з█Б╪▒ ╪╣┘Д┘Е ╪з┘Д╪м┘Б╪▒╪М ╪з╪│ ╪╡╪з╪▒┘Б ┌й╪з **"╪к┘Б╪╡█М┘Д█М ╪▓╪з╪ж┌Ж█Б┘Р ┘В╪│┘Е╪к" (Detailed Horoscope Analysis)** ╪к█М╪з╪▒ ┌й╪▒█М┌║█Ф
        
        **╪│╪о╪к █Б╪п╪з█М╪з╪к ╪и╪▒╪з╪ж█Т ╪▒╪▓┘Д┘╣ (STRICT INSTRUCTIONS):**
        1. **╪з╪╣╪п╪з╪п ┌Ж┌╛┘╛╪з╪ж█М┌║:** ╪м┘И╪з╪и ┘Е█М┌║ ┘Ж╪з┘Е ┌й█Т ╪з╪╣╪п╪з╪п╪М ╪з╪и╪м╪п ┌й╪з ╪н╪│╪з╪и╪М █М╪з ╪м┘Е╪╣ ╪к┘Б╪▒█М┘В (Calculation Breakdown) **█Б╪▒┌п╪▓ ┘Ж█Б ╪п┌й┌╛╪з╪ж█М┌║**█Ф ╪╡╪з╪▒┘Б ┌й┘И ╪╡╪▒┘Б ┘Ж╪к╪з╪ж╪м (Results) ╪│█Т ╪║╪▒╪╢ █Б█Т█Ф
        2. **┌й┘И╪ж█М ┘╣█М╪и┘Д ┘Ж█Б█М┌║:** ╪▓╪з╪ж┌Ж█Т ┌й╪з ┘Ж┘В╪┤█Б █М╪з ┘╣█М╪и┘Д (Grid) █Б╪▒┌п╪▓ ┘Ж█Б ╪и┘Ж╪з╪ж█М┌║█Ф ╪з╪│ ┌й█М ╪м┌п█Б 12 ┌п┌╛╪▒┘И┌║ ┌й█Т ╪н╪з┘Д╪з╪к ┌й┘И **╪и┘Д┘╣ ┘╛┘И╪з╪ж┘Ж┘╣╪│ █М╪з ┘Д╪│┘╣** ┌й█М ╪┤┌й┘Д ┘Е█М┌║ ┘Д┌й┌╛█М┌║ ╪к╪з┌й█Б ┘Е┘И╪и╪з╪ж┘Д ┘╛╪▒ ╪в╪│╪з┘Ж█М ╪│█Т ┘╛┌С┌╛╪з ╪м╪з ╪│┌й█Т█Ф
        
        **╪▒┘╛┘И╪▒┘╣ ┌й╪з ┘Б╪з╪▒┘Е█М┘╣ (Output Format):**
        
        **╪н╪╡█Б ╪з┘И┘Д: ┌й┘И╪з╪ж┘Б ┘И ╪│╪к╪з╪▒█Б**
        - **╪в┘╛ ┌й╪з ╪и╪▒╪м (Zodiac):** [█М█Б╪з┌║ ┘Д┌й┌╛█М┌║]
        - **╪н╪з┌й┘Е ╪│╪к╪з╪▒█Б (Planet):** [█М█Б╪з┌║ ┘Д┌й┌╛█М┌║]
        - **╪╣┘Ж╪╡╪▒ (Element):** (╪в┌п╪М ┘Е┘╣█М╪М █Б┘И╪з╪М █М╪з ┘╛╪з┘Ж█М)
        - **┘Д┌й█М ┘╛╪к┌╛╪▒ (Gemstone):** [█М█Б╪з┌║ ┘Д┌й┌╛█М┌║]
        
        **╪н╪╡█Б ╪п┘И┘Е: 12 ┌п┌╛╪▒┘И┌║ ┌й╪з ╪з╪н┘И╪з┘Д (House Analysis)**
        (█М█Б╪з┌║ 12 ┌п┌╛╪▒┘И┌║ ┌й█Т ╪з╪л╪▒╪з╪к ┌й┘И ┘Д╪│┘╣ ┌й█М ╪╡┘И╪▒╪к ┘Е█М┌║ ┘Д┌й┌╛█М┌║╪М ╪м█М╪│█Т:
        1. **╪░╪з╪к ╪з┘И╪▒ ╪┤╪о╪╡█М╪к:** ...
        2. **┘Е╪з┘Д ┘И ╪п┘И┘Д╪к:** ...
        ┘И╪║█М╪▒█Б)

        **╪н╪╡█Б ╪│┘И┘Е: ╪к┘Б╪╡█М┘Д█М ╪н╪з┘Д╪з╪к ┘И ┘И╪з┘В╪╣╪з╪к (Detailed Predictions)**
        - **╪╡╪н╪к (Health):** ┌й┘И┘Ж ╪│█М ╪и█М┘Е╪з╪▒█М ┌й╪з ╪о╪п╪┤█Б █Б█Т ╪з┘И╪▒ ╪з╪н╪к█М╪з╪╖ ┌й█М╪з █Б█Т╪Я
        - **┌й╪з╪▒┘И╪и╪з╪▒ ┘И ╪▒╪▓┘В:** ┌й█М╪з ┘Ж┘И┌й╪▒█М ╪и█Б╪к╪▒ █Б█Т █М╪з ┌й╪з╪▒┘И╪и╪з╪▒╪Я ┘Е╪з┘Д█М ╪н╪з┘Д╪з╪к ┌й╪и ╪╣╪▒┘И╪м ┘╛╪▒ █Б┘И┌║ ┌п█Т╪Я
        - **╪┤╪з╪п█М ┘И ┘Е╪н╪и╪к:** ╪з╪▓╪п┘И╪з╪м█М ╪▓┘Ж╪п┌п█М ┌й█М╪│█М ╪▒█Б█Т ┌п█М╪Я ╪┤╪▒█М┌й ╪н█М╪з╪к ┌й╪з ┘Е╪▓╪з╪м ┌й█М╪│╪з █Б┘И┌п╪з╪Я
        - **╪п┘И╪│╪к ┘И ╪п╪┤┘Е┘Ж:** ┌й┘Ж ┘Д┘И┌п┘И┌║ ╪│█Т ╪и┌Ж┘Ж╪з ┌Ж╪з█Б█М█Т╪Я
        
        ┘Ж┘И┘╣: ╪▒┘╛┘И╪▒┘╣ ╪з█М┌й ┘Е╪│╪к┘Ж╪п ┘Ж╪м┘И┘Е█М ┌й█М ╪╖╪▒╪н ┘╛╪▒╪з╪│╪▒╪з╪▒ ╪з┘Ж╪п╪з╪▓ ┘Е█М┌║ █Б┘И╪М ╪з┘И╪▒ ┘Ж╪з┘Е ╪з┘И╪▒ ┘И╪з┘Д╪п█Б ┌й█Т ┘Ж╪з┘Е ┌й█Т ╪з╪л╪▒╪з╪к ┌й┘И ┘И╪з╪╢╪н ┌й╪▒█Т█Ф
        `;
    } else if (type === 'match') {
        prompt = `
        **┘Е┘И╪╢┘И╪╣: ┘Е┘Ж╪з╪│╪и╪к ╪з┘И╪▒ ╪▒╪┤╪к█Б (Compatibility Analysis)**
        
        ┘╛█Б┘Д╪з ┘Ж╪з┘Е: ${data.name}
        ╪п┘И╪│╪▒╪з ┘Ж╪з┘Е: ${extraData.name2}
        ╪▒╪┤╪к█Б ┌й█М ┘Ж┘И╪╣█М╪к: ${extraData.relationType} (┘Е╪л┘Д╪з┘Л: ╪┤╪з╪п█М╪М ╪п┘И╪│╪к█М╪М ┌й╪з╪▒┘И╪и╪з╪▒)

        ╪з┘Ж ╪п┘И┘Ж┘И┌║ ┘Ж╪з┘Е┘И┌║ ┌й█Т ╪з╪╣╪п╪з╪п (╪з╪и╪м╪п ╪з┘И╪▒ ┘Ж╪м┘И┘Е) ┌й╪з ┘Е┘И╪з╪▓┘Ж█Б ┌й╪▒█М┌║ ╪з┘И╪▒ ╪и╪к╪з╪ж█М┌║:
        1. **┘Е╪╖╪з╪и┘В╪к ┌й╪з ┘Б█М╪╡╪п (Compatibility Percentage):** (┘Е╪л┘Д╪з┘Л 80┘к)
        2. **┌й█М┘Е╪│┘╣╪▒█М:** ╪з┘Ж ┌й█М ╪░█Б┘Ж█М ╪з┘И╪▒ ┘В┘Д╪и█М █Б┘Е ╪в█Б┘Ж┌п█М ┌й█М╪│█М █Б█Т╪Я
        3. **┘Е╪╢╪и┘И╪╖ ┘╛█Б┘Д┘И:** ╪з╪│ ╪▒╪┤╪к█Т ┘Е█М┌║ ┌й█М╪з ┌Ж█М╪▓ ╪з┌Ж┌╛█М ╪▒█Б█Т ┌п█М╪Я
        4. **┌й┘Е╪▓┘И╪▒ ┘╛█Б┘Д┘И ╪з┘И╪▒ ╪з╪н╪к█М╪з╪╖:** ┌й┘Ж ╪и╪з╪к┘И┌║ ┘╛╪▒ ╪м┌╛┌п┌С╪з █Б┘И ╪│┌й╪к╪з █Б█Т╪Я
        5. **╪н╪к┘Е█М ┘Е╪┤┘И╪▒█Б:** ┌й█М╪з █М█Б ╪м┘И┌С ┘Е╪и╪з╪▒┌й █Б█Т █М╪з ┘Ж█Б█М┌║╪Я
        
        ╪м┘И╪з╪и ┘Е█М┌║ Emojis ╪з╪│╪к╪╣┘Е╪з┘Д ┌й╪▒█М┌║ ╪з┘И╪▒ ┘Б█М╪╡┘Д█Б ┌й┘Ж ╪▒╪з╪ж█Т ╪п█М┌║█Ф
        `;
    } else if (type === 'istikhara') {
        prompt = `
        **┘Е┘И╪╢┘И╪╣: ╪з╪│╪к╪о╪з╪▒█Б / AI ╪▒┘И╪н╪з┘Ж█М ╪▒█Б┘Ж┘Е╪з╪ж█М**
        
        ╪│╪з╪ж┘Д ┌й╪з ┘Ж╪з┘Е: ${data.name}
        ╪│┘И╪з┘Д: "${extraData.question}"
        
        ╪╣┘Д┘Е ╪з┘Д╪з╪╣╪п╪з╪п ╪з┘И╪▒ ╪╣┘Д┘Е ╪з┘Д╪│╪з╪╣╪з╪к (Time Science) ┌й█Т ╪з╪╡┘И┘Д┘И┌║ ┌й█Т ┘Е╪╖╪з╪и┘В ╪з╪│ ╪│┘И╪з┘Д ┌й╪з ┘Б┘И╪▒█М ╪м┘И╪з╪и (╪з╪│╪к╪о╪з╪▒█Б) ┘Ж┌й╪з┘Д█М┌║:
        1. **╪м┘И╪з╪и:** ┌й█М╪з █М█Б ┌й╪з┘Е ┌й╪▒┘Ж╪з ┌Ж╪з█Б█М█Т╪Я (█Б╪з┌║ / ┘Ж█Б█М┌║ / ╪з┘Ж╪к╪╕╪з╪▒ ┌й╪▒█М┌║)
        2. **┘И╪м█Б:** ╪з╪╣╪п╪з╪п ┌й█М╪з ╪з╪┤╪з╪▒█Б ┌й╪▒ ╪▒█Б█Т █Б█М┌║╪Я (┘Е╪л╪и╪к/┘Е┘Ж┘Б█М)
        3. **╪в╪м ┌й█М ╪к┘И╪з┘Ж╪з╪ж█М:** ┌й█М╪з ╪в╪м ┌й╪з ┘И┘В╪к ╪з╪│ ┌й╪з┘Е ┌й█Т ┘Д█М█Т ┘Е┘И╪▓┘И┌║ █Б█Т╪Я
        4. **┘Е╪┤┘И╪▒█Б:** ┌й╪з┘Е█М╪з╪и█М ┌й█Т ┘Д█М█Т ┌й┘И┘Ж ╪│╪з ╪╡╪п┘В█Б █М╪з ┘И╪▒╪п ┌й╪▒█М┌║╪Я
        
        ╪м┘И╪з╪и ┘Ж█Б╪з█М╪к ┘Е╪о╪к╪╡╪▒╪М ┘И╪з╪╢╪н ╪з┘И╪▒ ╪▒┘И╪н╪з┘Ж█М █Б┘И█Ф
        `;
    } else if (type === 'modern') {
         prompt = `
        **┘Е┘И╪╢┘И╪╣: ╪м╪п█М╪п ┌Ж█М╪▓┘И┌║ ┌й╪з ┘Ж╪м┘И┘Е█М ╪з╪л╪▒ (Modern Astro Analysis)**
        
        ┘Ж╪з┘Е: ${data.name}
        ${extraData.mobile ? `┘Е┘И╪и╪з╪ж┘Д ┘Ж┘Е╪и╪▒: ${extraData.mobile}` : ''}
        ${extraData.vehicle ? `┌п╪з┌С█М ┘Ж┘Е╪и╪▒: ${extraData.vehicle}` : ''}
        ${extraData.house ? `┌п┌╛╪▒/┘Е┌й╪з┘Ж ┘Ж┘Е╪и╪▒: ${extraData.house}` : ''}
        
        ╪з┘Ж ╪м╪п█М╪п ┘Ж┘Е╪и╪▒┘И┌║ ┌й╪з ╪╡╪з╪▒┘Б ┌й█М ╪▓┘Ж╪п┌п█М ┘╛╪▒ ╪з╪л╪▒ ╪и╪к╪з╪ж█М┌║:
        1. **┘Е┘И╪и╪з╪ж┘Д ┘Ж┘Е╪и╪▒:** ┌й█М╪з █М█Б ┘Ж┘Е╪и╪▒ ╪з┘Ж ┌й█Т ┌й╪з╪▒┘И╪и╪з╪▒/╪▒╪з╪и╪╖┘И┌║ ┌й█Т ┘Д█М█Т ┘Д┌й█М █Б█Т╪Я
        2. **┌п╪з┌С█М:** ┌й█М╪з ┌п╪з┌С█М ┌й╪з ┘Ж┘Е╪и╪▒ ╪│┘Б╪▒ ┌й█Т ┘Д█М█Т ┘Е╪н┘Б┘И╪╕ █Б█Т╪Я
        3. **┌п┌╛╪▒:** ┌й█М╪з ┌п┌╛╪▒ ┌й╪з ┘Ж┘Е╪и╪▒ ╪│┌й┘И┘Ж ┘И╪з┘Д╪з █Б█Т╪Я
        
        ╪│╪з╪к┌╛ █Б█М **┘Д┌й█М ┘Ж┘Е╪и╪▒╪▓** ╪и┌╛█М ╪м┘Ж╪▒█М┘╣ ┌й╪▒█М┌║ (┘Д╪з┘╣╪▒█М █М╪з ┘╛╪▒╪з╪ж╪▓ ╪и╪з┘Ж┌И ┌й█Т ┘Д█М█Т)█Ф
        `;
    }

    return generateSpiritualResponse(prompt);
};

export const getBlackMagicDiagnosis = async (data: any, type: 'diagnosis' | 'history' | 'protection', query?: string): Promise<string> => {
    const val = (v: string) => v && v.trim() !== '' ? v : null;

    const baseInfo = `
    ┘Ж╪з┘Е: ${data.name}
    ┘И╪з┘Д╪п█Б ┌й╪з ┘Ж╪з┘Е: ${data.motherName || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ┘И╪з┘Д╪п ┌й╪з ┘Ж╪з┘Е: ${data.fatherName || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ╪к╪з╪▒█М╪о ┘╛█М╪п╪з╪ж╪┤: ${data.dob || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М ┌п╪ж█М'}
    ┘И┘В╪к┘Р ┘╛█М╪п╪з╪ж╪┤: ${data.birthTime || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ┘Е┘И╪м┘И╪п█Б ╪к╪з╪▒█М╪о: ${data.date || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М ┌п╪ж█М'}
    ╪п┘Ж: ${data.day || '┘Б╪▒╪з█Б┘Е ┘Ж█Б█М┌║ ┌й█М╪з ┌п█М╪з'}
    ┘Е╪│╪ж┘Д█Б/╪╣┘Д╪з┘Е╪з╪к: ${data.problem || '╪╣╪з┘Е ╪к╪┤╪о█М╪╡'}
    `;

    let prompt = "";

    if (type === 'diagnosis') {
        prompt = `
        ${baseInfo}
        
        **╪к╪┤╪о█М╪╡ ┌й╪з ╪╖╪▒█М┘В█Б (System Logic):**
        1. ╪в┘╛ ┌й┘И ┌Ж╪з█Б█М█Т ┌й█Б ┘╛╪│ ┘╛╪▒╪п█Б (Background) ┘Е█М┌║ ┘Б╪▒╪з█Б┘Е ┌й╪▒╪п█Б "┘Ж╪з┘Е"╪М "┘И╪з┘Д╪п█Б ┌й╪з ┘Ж╪з┘Е"╪М "╪п┘Ж" ╪з┘И╪▒ "╪к╪з╪▒█М╪о" ┌й█Т ┌й┘Д ╪з╪╣╪п╪з╪п (Abjad) ╪м┘Е╪╣ ┌й╪▒█М┌║█Ф
        2. ╪н╪з╪╡┘Д █Б┘И┘Ж█Т ┘И╪з┘Д█Т ┌й┘Д ┘Е╪м┘Е┘И╪╣█Т ┌й┘И **4 ┘╛╪▒ ╪к┘В╪│█М┘Е ┌й╪▒█М┌║** (Divide Sum by 4)█Ф
        3. ╪м┘И ╪и╪з┘В█М (Remainder) ╪и┌Ж█Т (█М╪╣┘Ж█М 0╪М 1╪М 2╪М █М╪з 3)╪М ╪╡╪▒┘Б ╪з╪│ ┌й█Т ┘Е╪╖╪з╪и┘В ┘Ж█М┌Ж█Т ╪п█М ┌п╪ж█М ╪╣╪и╪з╪▒╪к ╪м┘И╪з╪и ┘Е█М┌║ ┘Д┌й┌╛█М┌║█Ф

        **╪з┌п╪▒ ╪и╪з┘В█М 1 ╪и┌Ж█Т (Remainder = 1):**
        "╪в┘╛ ┌й┘И ┌й╪│█М ┘В╪│┘Е ┌й╪з ╪м╪з╪п┘И ┘Ж█Б█М┌║ █Б█Т╪М ╪в┘╛ ┌й┘И ╪з┘Ж╪п╪▒┘И┘Ж█М ╪и╪о╪з╪▒ ╪з┘И╪▒ ╪п█М┌п╪▒ ╪з┘Е╪▒╪з╪╢ █Б█М┌║█Ф ╪в┘╛ ┌й╪│█М ┘Е╪│╪к┘Ж╪п ╪н┌й█М┘Е ╪│█Т ╪▒╪з╪и╪╖█Б ┌й╪▒█М┌║█Ф"

        **╪з┌п╪▒ ╪и╪з┘В█М 2 ╪и┌Ж█Т (Remainder = 2):**
        "╪в┘╛ ┌й┘И ┌й╪│█М ┘В╪│┘Е ┌й╪з ╪м╪з╪п┘И █М╪з ┌Ж┌╛█М┌С ┌Ж┌╛╪з┌С ┘Ж█Б█М┌║ █Б█Т█Ф ╪в┘╛ ╪з┘╛┘Ж█Т ╪з┘Е╪▒╪з╪╢ ┌й█Т ╪╣┘Д╪з╪м ┌й█Т ┘Д█М█Т ┌й╪│█М ╪н┌й█М┘Е ╪│█Т ╪▒╪з╪и╪╖█Б ┌й╪▒█М┌║█Ф"

        **╪з┌п╪▒ ╪и╪з┘В█М 3 ╪и┌Ж█Т (Remainder = 3):**
        "╪в┘╛ ┘╛╪▒ ╪в╪│█М╪и ┘И ╪м┘Ж╪з╪к ┌й╪з ╪│╪з█М█Б █Б█Т█Ф ╪в┘╛ ╪з╪│ ┌й█Т ╪╣┘Д╪з╪м ┌й█Т ┘Д█М█Т ╪з┘╛┘Ж█Т ┘Е╪│╪к┘Ж╪п ╪▒┘И╪н╪з┘Ж█М ┘Е╪╣╪з┘Д╪м ╪│█Т ╪▒╪з╪и╪╖█Б ┌й╪▒█М┌║█Ф ╪з┌п╪▒ ╪в┘╛ ┌й┘И ┌й┘И╪ж█М ╪▒┘И╪н╪з┘Ж█М ┘Е╪╣╪з┘Д╪м ┘Ж█Б█М┌║ ┘Е╪╣┘Д┘И┘Е ╪к┘И ╪в┘╛ ╪н┌й█М┘Е ╪║┘Д╪з┘Е █М╪з╪│█М┘Ж ╪в╪▒╪з╪ж█М┌║ (┌й█Б╪▒┘И┌С ┘╛┌й╪з) █М╪з ╪н╪з╪м█М ╪з╪┤┘Б╪з┘В (┘Е╪з█Б╪▒ ╪╣┘Е┘Д█М╪з╪к╪М ╪о╪з┘Ж█М┘И╪з┘Д) ╪│█Т ╪▒╪з╪и╪╖█Б ┌й╪▒█М┌║█Ф ╪▒╪з╪и╪╖█Б ┌й█Т ┘Д█М█Т ╪з╪│█М ╪з█М┘╛ ┘Е█М┌║ '╪▒╪з╪и╪╖█Б' ┘И╪з┘Д█Т ╪н╪╡█Б ┘Е█М┌║ ╪м╪з╪ж█М┌║█Ф"

        **╪з┌п╪▒ ╪и╪з┘В█М 0 ╪и┌Ж█Т (█М╪╣┘Ж█М ┘╛┘И╪▒╪з ╪к┘В╪│█М┘Е █Б┘И ╪м╪з╪ж█Т) (Remainder = 0):**
        "╪в┘╛ ┘╛╪▒ ┌й╪│█М ┘Ж█Т ┌й╪з┘Д╪з ╪м╪з╪п┘И ┌й╪▒╪з█М╪з █Б┘И╪з █Б█Т ╪з┘И╪▒ ╪в┘╛ ┘Е╪│╪з╪ж┘Д ┘Е█М┌║ ┌п┌╛╪▒█Т █Б┘И╪ж█Т █Б█М┌║█Ф ╪в┘╛ ╪з╪│ ┌й█Т ╪╣┘Д╪з╪м ┌й█Т ┘Д█М█Т ╪з┘╛┘Ж█Т ┘Е╪│╪к┘Ж╪п ╪▒┘И╪н╪з┘Ж█М ┘Е╪╣╪з┘Д╪м ╪│█Т ╪▒╪з╪и╪╖█Б ┌й╪▒█М┌║█Ф ╪з┌п╪▒ ╪в┘╛ ┌й┘И ┌й┘И╪ж█М ╪▒┘И╪н╪з┘Ж█М ┘Е╪╣╪з┘Д╪м ┘Ж█Б█М┌║ ┘Е╪╣┘Д┘И┘Е ╪к┘И ╪в┘╛ ╪н┌й█М┘Е ╪║┘Д╪з┘Е █М╪з╪│█М┘Ж ╪в╪▒╪з╪ж█М┌║ (┌й█Б╪▒┘И┌С ┘╛┌й╪з) █М╪з ╪н╪з╪м█М ╪з╪┤┘Б╪з┘В (┘Е╪з█Б╪▒ ╪╣┘Е┘Д█М╪з╪к╪М ╪о╪з┘Ж█М┘И╪з┘Д) ╪│█Т ╪▒╪з╪и╪╖█Б ┌й╪▒█М┌║█Ф ╪▒╪з╪и╪╖█Б ┌й█Т ┘Д█М█Т ╪з╪│█М ╪з█М┘╛ ┘Е█М┌║ '╪▒╪з╪и╪╖█Б' ┘И╪з┘Д█Т ╪н╪╡█Б ┘Е█М┌║ ╪м╪з╪ж█М┌║█Ф"

        **╪│╪о╪к █Б╪п╪з█М╪з╪к:**
        - ╪м┘И╪з╪и ┘Е█М┌║ ╪з╪╣╪п╪з╪п╪М ╪м┘Е╪╣ ╪к┘Б╪▒█М┘В╪М █М╪з ╪к┘В╪│█М┘Е ┌й╪з ╪╣┘Е┘Д █Б╪▒┌п╪▓ ╪╕╪з█Б╪▒ ┘Ж█Б ┌й╪▒█М┌║█Ф
        - ╪╡╪▒┘Б ╪з┘И╪▒ ╪╡╪▒┘Б ╪з┘И┘╛╪▒ ╪п█М ┌п╪ж█М ┘Е╪к╪╣┘Д┘В█Б ╪з╪▒╪п┘И ╪╣╪и╪з╪▒╪к (Result Text) ┘Д┌й┌╛█М┌║█Ф
        `;
    } else if (type === 'history') {
        prompt = `
        ${baseInfo}
        
        **┘Е┘И╪╢┘И╪╣: ╪к╪з╪▒█М╪о█М ╪▒┘И╪н╪з┘Ж█М ╪к╪м╪▓█М█Б (Historical Spiritual Analysis)**
        
        ╪╡╪з╪▒┘Б ┌й█Т ┘Е╪з╪╢█М ╪з┘И╪▒ ┘Е┘И╪м┘И╪п█Б ╪н╪з┘Д╪з╪к ┌й╪з ┘Е┘И╪з╪▓┘Ж█Б ┌й╪▒█М┌║:
        1. **┘Е╪з╪╢█М ┌й╪з ╪к╪╣┘Д┘В:** ┌й█М╪з ╪з┘Ж ┌й█М ┘Е┘И╪м┘И╪п█Б ┘Е╪┤┌й┘Д╪з╪к ┌й╪з ╪к╪╣┘Д┘В ┘Е╪з╪╢█М ┌й█М ┌й╪│█М ╪║┘Д╪╖█М╪М ╪п╪┤┘Е┘Ж█М╪М █М╪з ╪о╪з┘Ж╪п╪з┘Ж█М ╪з╪л╪▒╪з╪к ╪│█Т █Б█Т╪Я
        2. **┘И┘В╪к ┌й╪з ╪к╪м╪▓█М█Б:** ╪з┘Ж ┌й█М ╪к╪з╪▒█М╪о ┘╛█М╪п╪з╪ж╪┤ ┌й█Т ┘Е╪╖╪з╪и┘В ┌й┘И┘Ж ╪│╪з ┘И┘В╪к ╪з┘Ж ┘╛╪▒ ╪и┌╛╪з╪▒█М ┌п╪▓╪▒╪з █Б█Т╪Я
        3. **┘Е╪│╪к┘В╪и┘Д ┌й█М ┘╛█М╪┤┌п┘И╪ж█М:** ╪з┌п╪▒ ╪╣┘Д╪з╪м ┘Ж█Б ┌й█М╪з ┌п█М╪з ╪к┘И ╪з┌п┘Д█Т 6 ┘Е╪з█Б ┘Е█М┌║ ╪н╪з┘Д╪з╪к ┌й╪│ ╪╖╪▒┘Б ╪м╪з ╪│┌й╪к█Т █Б█М┌║╪Я
        4. **╪▒╪м╪╣╪к █М╪з ╪и┘Ж╪п╪┤:** ┌й█М╪з ╪з┘Ж ┘╛╪▒ ┌й┘И╪ж█М ┘╛╪▒╪з┘Ж█М ╪▒╪м╪╣╪к █М╪з ╪о╪з┘Ж╪п╪з┘Ж█М ╪и┘Ж╪п╪┤ █Б█Т╪Я
        `;
    } else if (type === 'protection') {
        prompt = `
        ${baseInfo}
        
        **┘Е┘И╪╢┘И╪╣: ╪▒┘И╪н╪з┘Ж█М ╪╣┘Д╪з╪м╪М ╪к╪н┘Б╪╕ ╪з┘И╪▒ ╪з╪│╪к╪║┘Б╪з╪▒ (Remedies & Protection)**
        
        ╪з╪│ ╪╡╪з╪▒┘Б ┌й█М ╪к╪┤╪о█М╪╡ ┌й█Т ┘Е╪╖╪з╪и┘В ╪╣┘Д╪з╪м ╪к╪м┘И█М╪▓ ┌й╪▒█М┌║:
        1. **┘В╪▒╪в┘Ж█М ╪╣┘Д╪з╪м:** ┌й┘И┘Ж ╪│█М ╪│┘И╪▒╪к█М┌║ ┘╛┌С┌╛┘Ж█М ┌Ж╪з█Б╪ж█М┌║╪Я (┘Е╪л┘Д╪з┘Л ╪│┘И╪▒█Б ╪и┘В╪▒█Б╪М ┘Е┘Ж╪▓┘Д╪М ┘И╪║█М╪▒█Б)
        2. **█М┘И┘Е█М█Б ╪з╪░┌й╪з╪▒:** ╪╡╪и╪н ┘И ╪┤╪з┘Е ┌й█Т ┘И█Б ╪з╪░┌й╪з╪▒ ╪и╪к╪з╪ж█М┌║ ╪м┘И ╪м╪з╪п┘И ╪з┘И╪▒ ┘Ж╪╕╪▒ ┌й┘И ┌й╪з┘╣╪к█Т █Б█М┌║█Ф
        3. **╪╡╪п┘В█Б:** ╪и┘Д╪з╪д┌║ ┌й┘И ┘╣╪з┘Д┘Ж█Т ┌й█Т ┘Д█М█Т ┌й┘И┘Ж ╪│╪з ╪╡╪п┘В█Б (┌п┘И╪┤╪к╪М ╪п╪з┘Д╪М ┘╛█М╪│█Т) ╪п█М┘Ж╪з ┌Ж╪з█Б█М█Т╪Я
        4. **╪н╪╡╪з╪▒ ┌й╪з ╪╖╪▒█М┘В█Б:** ╪│┘И┘Ж█Т ╪│█Т ┘╛█Б┘Д█Т ╪з┘╛┘Ж█Т ╪к╪н┘Б╪╕ ┌й╪з ╪╖╪▒█М┘В█Б ╪│┌й┌╛╪з╪ж█М┌║█Ф
        5. **┘Е╪л╪и╪к ╪к┘И╪з┘Ж╪з╪ж█М:** ┌п┌╛╪▒ ┘Е█М┌║ ┘Е╪л╪и╪к ╪з┘Ж╪▒╪м█М ┘Д╪з┘Ж█Т ┌й█Т ┘Д█М█Т ┌й█М╪з ┌й╪▒█М┌║╪Я
        
        ╪╡╪▒┘Б ┘Ж┘И╪▒█М ╪з┘И╪▒ ╪┤╪▒╪╣█М ┘И╪╕╪з╪ж┘Б ╪и╪к╪з╪ж█М┌║█Ф ┌й┘И╪ж█М ╪║█М╪▒ ╪┤╪▒╪╣█М ╪╣┘Е┘Д ┘Ж█Б ╪и╪к╪з╪ж█М┌║█Ф
        `;
    }

    return generateSpiritualResponse(prompt);
};

export const getInitialDiagnosis = async (symptoms: string, image?: string): Promise<string> => {
  const prompt = `
  ┘Е╪▒█М╪╢ ┌й█М ╪╣┘Д╪з┘Е╪з╪к: ${symptoms}
  ${image ? '┘Ж┘И┘╣: ╪│╪з╪к┌╛ ╪п█М ┌п╪ж█М ╪к╪╡┘И█М╪▒ ┌й╪з ╪и┌╛█М ╪╖╪и█М ┘Е╪╣╪з╪ж┘Ж█Б (Visual Examination) ┌й╪▒█М┌║ ╪з┘И╪▒ ╪╣┘Д╪з┘Е╪з╪к ┌й█Т ╪│╪з╪к┌╛ ┘Е┘Д╪з ┌й╪▒ ╪к╪┤╪о█М╪╡ ┌й╪▒█М┌║█Ф' : ''}
  
  ╪и╪▒╪з█Б ┌й╪▒┘Е ╪з┘Ж ╪╣┘Д╪з┘Е╪з╪к ╪з┘И╪▒ ╪к╪╡┘И█М╪▒ (╪з┌п╪▒ █Б┘И) ┌й█М ╪и┘Ж█М╪з╪п ┘╛╪▒ ╪╡╪▒┘Б **"╪и█М┘Е╪з╪▒█М ┌й█М ╪к╪┤╪о█М╪╡" (Diagnosis)** ┘Б╪▒╪з█Б┘Е ┌й╪▒█М┌║█Ф
  
  **╪з█Б┘Е █Б╪п╪з█М╪з╪к:**
  1. **╪к╪╣╪п╪з╪п:** ╪╣┘Д╪з┘Е╪з╪к ┌й█Т ┘Е╪╖╪з╪и┘В ╪▓█М╪з╪п█Б ╪│█Т ╪▓█М╪з╪п█Б **3 ┘Е┘Е┌й┘Ж█Б ╪и█М┘Е╪з╪▒█М┘И┌║** (Top 3 Diseases) ┌й█Т ┘Ж╪з┘Е ┘Д┌й┌╛█М┌║█Ф
  2. **╪к┘Б╪╡█М┘Д:** █Б╪▒ ╪и█М┘Е╪з╪▒█М ┌й█Т ╪и╪з╪▒█Т ┘Е█М┌║ 1-2 ┘Д╪з╪ж┘Ж┘И┌║ ┘Е█М┌║ ╪и╪к╪з╪ж█М┌║ ┌й█Б █М█Б ┌й█М┘И┌║ █Б┘И╪к█М █Б█Т█Ф
  3. **┌й┘И╪ж█М ╪╣┘Д╪з╪м ┘Ж█Б█М┌║:** ╪з╪│ ┘Е╪▒╪н┘Д█Т ┘╛╪▒ ┌й┘И╪ж█М ╪п┘И╪з █М╪з ┘Ж╪│╪о█Б █Б╪▒┌п╪▓ ┘Ж█Б ┘Д┌й┌╛█М┌║█Ф ╪╡╪▒┘Б ╪и█М┘Е╪з╪▒█М ┌й█М ┘╛█Б┌Ж╪з┘Ж ╪и╪к╪з╪ж█М┌║█Ф
  
  ╪м┘И╪з╪и ╪з╪▒╪п┘И ┘Е█М┌║ █Б┘И█Ф
  `;

  if (image) {
    return analyzeImageWithText(prompt, image);
  }
  return generateSpiritualResponse(prompt);
};

export const getMedicalDiagnosis = async (symptoms: string, treatmentType: string, image?: string): Promise<string> => {
  const prompt = `
  ┘Е╪▒█М╪╢ ┌й█М ╪╣┘Д╪з┘Е╪з╪к: ${symptoms}
  ┘Е┘Ж╪к╪о╪и ╪╖╪▒█М┘В█Б ╪╣┘Д╪з╪м: ${treatmentType}
  ${image ? '┘Ж┘И┘╣: ╪к╪╡┘И█М╪▒ ┌й╪з ╪и┌╛█М ╪о█М╪з┘Д ╪▒┌й┌╛█М┌║ ╪к╪з┌й█Б ╪п┘И╪з █М╪з ╪╣┘Д╪з╪м ╪к╪╡┘И█М╪▒ ┘Е█М┌║ ┘Ж╪╕╪▒ ╪в┘Ж█Т ┘И╪з┘Д█М ╪н╪з┘Д╪к ┌й█Т ┘Е╪╖╪з╪и┘В █Б┘И█Ф' : ''}

  ╪в┘╛ ╪з█М┌й ┘Е╪з█Б╪▒ ╪╖╪и█М╪и █Б█М┌║█Ф ┘Е┘Ж╪к╪о╪и ╪╖╪▒█М┘В█Б ╪╣┘Д╪з╪м ┌й█Т ┘Е╪╖╪з╪и┘В ╪и╪з┘Д┌й┘Д ╪п╪▒╪│╪к ╪з┘И╪▒ ┘Ж┘╛█Т ╪к┘Д█Т ┘Ж╪│╪о█Т ┘Д┌й┌╛█М┌║█Ф
  **╪к╪┤╪о█М╪╡ ┘Ж█Б ┘Д┌й┌╛█М┌║** (┌й█М┘И┘Ж┌й█Б ┘И█Б ┘╛█Б┘Д█Т █Б┘И ┌Ж┌й█М █Б█Т)╪М ╪╡╪▒┘Б ╪╣┘Д╪з╪м ┘Д┌й┌╛█М┌║█Ф

  **╪з┌п╪▒ "╪╖╪и █М┘И┘Ж╪з┘Ж█М ┘И ╪з╪│┘Д╪з┘Е█М" (Unani/Islamic) █Б█Т ╪к┘И ╪п╪▒╪м ╪░█М┘Д 5 ┌Ж█М╪▓█М┌║ ┘Д╪з╪▓┘Е█М ┘Д┌й┌╛█М┌║:**
  1. **┘Е╪▒┌й╪и ╪з╪п┘И█М╪з╪к (3 ╪╣╪п╪п):** ╪з█М┌й ┘Е╪╣╪м┘И┘Ж ┌й╪з ┘Ж╪з┘Е╪М ╪з█М┌й ╪о┘Е█М╪▒█Б █М╪з ╪з╪╖╪▒█М┘Б┘Д █М╪з ╪│┘Б┘И┘Б╪М ╪з┘И╪▒ ╪з█М┌й ╪┤╪▒╪и╪к (╪и█М┘Е╪з╪▒█М ┌й█Т ┘Е╪╖╪з╪и┘В)█Ф
  2. **┘Ж╪│╪о█Б:** ╪з█М┌й ┌п┌╛╪▒█М┘Д┘И ┘Ж╪│╪о█Б (Nuskha) ╪з╪м╪▓╪з╪б ┌й█Т ╪│╪з╪к┌╛█Ф
  3. **┘В█Б┘И█Б/╪м┘И╪┤╪з┘Ж╪п█Б:** ┘Е╪▒╪╢ ┌й█Т ┘Е╪╖╪з╪и┘В ╪з█М┌й ┘В█Б┘И█Б█Ф
  *┘Ж┘И┘╣: █Б╪▒ ┌Ж█М╪▓ ┌й╪з ╪╖╪▒█М┘В█Б ╪з╪│╪к╪╣┘Е╪з┘Д ╪з┘И╪▒ ┘╛╪▒█Б█М╪▓ ┘Д╪з╪▓┘Е█М ┘Д┌й┌╛█М┌║█Ф*

  **╪з┌п╪▒ "╪з█М┘Д┘И┘╛█М╪к┌╛┌й" (Allopathic) █Б█Т ╪к┘И ╪п╪▒╪м ╪░█М┘Д 4 ┌Ж█М╪▓█М┌║ ┘Д╪з╪▓┘Е█М ┘Д┌й┌╛█М┌║:**
  1. ╪з█М┌й ┌й█М┘╛╪│┘И┘Д (Capsule)█Ф
  2. ╪з█М┌й ┌п┘И┘Д█М (Tablet)█Ф
  3. ╪з█М┌й ╪з┘Ж╪м█М┌й╪┤┘Ж (Injection) (╪з┌п╪▒ ╪╢╪▒┘И╪▒╪к █Б┘И╪М ┘И╪▒┘Ж█Б ┘Е╪к╪и╪з╪п┘Д ╪п┘И╪з)█Ф
  4. ╪з█М┌й ╪┤╪▒╪и╪к (Syrup)█Ф
  *┘Ж┘И┘╣: ╪о┘И╪▒╪з┌й╪М ╪╖╪▒█М┘В█Б ╪з╪│╪к╪╣┘Е╪з┘Д ╪з┘И╪▒ ┘╛╪▒█Б█М╪▓ ┘Д╪з╪▓┘Е█М ┘Д┌й┌╛█М┌║█Ф*

  **╪з┌п╪▒ "█Б┘И┘Е█М┘И┘╛█М╪к┌╛█М" (Homeopathy) █Б█Т ╪к┘И:**
  - ╪╡╪▒┘Б **3 ╪и█Б╪к╪▒█М┘Ж █Б┘И┘Е█М┘И┘╛█М╪к┌╛┌й ╪з╪п┘И█М╪з╪к** ╪з┘Ж ┌й█М ╪╖╪з┘В╪к (Potency) ┌й█Т ╪│╪з╪к┌╛ ┘Д┌й┌╛█М┌║█Ф
  - ╪╖╪▒█М┘В█Б ╪з╪│╪к╪╣┘Е╪з┘Д ╪з┘И╪▒ ┘╛╪▒█Б█М╪▓ ┘Д┌й┌╛█М┌║█Ф
  
  **╪з┌п╪▒ "╪н╪м╪з┘Е█Б" (Hijama) █Б█Т ╪к┘И:**
  - ╪и█М┘Е╪з╪▒█М ┌й█Т ┘Е╪╖╪з╪и┘В ┌й┘╛ ┘Д┌п╪з┘Ж█Т ┌й█Т ┘Е┘В╪з┘Е╪з╪к (Sunnah Points)█Ф
  - ╪з╪н╪к█М╪з╪╖█М ╪к╪п╪з╪и█М╪▒█Ф

  **╪з┌п╪▒ "┘Е╪│╪з╪м ╪к┌╛╪▒╪з┘╛█М" (Massage) █Б█Т ╪к┘И:**
  - ╪и█М┘Е╪з╪▒█М ┌й█Т ┘Е╪╖╪з╪и┘В ┘Е╪о╪╡┘И╪╡ ╪▒┘И╪║┘Ж (Oil) ┌й╪з ┘Ж╪з┘Е█Ф
  - ┘Е╪з┘Д╪┤ ┌й╪з ╪╖╪▒█М┘В█Б█Ф
  
  **╪з┌п╪▒ "╪з╪▒┘И┘Е╪з ╪к┌╛╪▒╪з┘╛█М" (Aromatherapy) █Б█Т ╪к┘И:**
  - ╪и█М┘Е╪з╪▒█М ┌й█Т ┘Е╪╖╪з╪и┘В ┘Е╪о╪╡┘И╪╡ ╪о┘И╪┤╪и┘И/╪к█М┘Д (Essential Oil)█Ф
  - ╪з╪│╪к╪╣┘Е╪з┘Д ┌й╪з ╪╖╪▒█М┘В█Б█Ф

  ╪м┘И╪з╪и ┘Е┌й┘Е┘Д ╪з╪▒╪п┘И ┘Е█М┌║╪М ╪╡╪з┘Б ╪│╪к┌╛╪▒╪з ╪з┘И╪▒ ┘Д╪│┘╣ ┌й█М ╪┤┌й┘Д ┘Е█М┌║ █Б┘И█Ф
  `;

  if (image) {
    return analyzeImageWithText(prompt, image);
  }
  return generateSpiritualResponse(prompt);
};

export const analyzeMedicine = async (image: string): Promise<string> => {
  const prompt = `
  █М█Б ╪з█М┌й ╪п┘И╪з╪ж█М (Medicine) ┌й█М ╪к╪╡┘И█М╪▒ █Б█Т█Ф
  ╪и╪▒╪з█Б ┌й╪▒┘Е ╪з╪│ ╪п┘И╪з╪ж█М ┌й┘И ╪┤┘Ж╪з╪о╪к ┌й╪▒█М┌║ ╪з┘И╪▒ ╪п╪▒╪м ╪░█М┘Д ╪к┘Б╪╡█М┘Д╪з╪к ┘Е┌й┘Е┘Д ╪з╪▒╪п┘И ┘Е█М┌║ ┘Б╪▒╪з█Б┘Е ┌й╪▒█М┌║:

  1. **╪п┘И╪з╪ж█М ┌й╪з ┘Ж╪з┘Е (Medicine Name):**
  2. **┘Б╪з╪▒┘Е┘И┘Д╪з (Formula/Ingredients):** (┌й█М┘Е█М┌й┘Д █М╪з █Б╪▒╪и┘Д ╪з╪м╪▓╪з╪б)
  3. **┘Б┘И╪з╪ж╪п (Uses/Benefits):** █М█Б ┌й╪│ ┘Е╪▒╪╢ ┌й█Т ┘Д█М█Т ╪з╪│╪к╪╣┘Е╪з┘Д █Б┘И╪к█М █Б█Т╪Я
  4. **┘Ж┘В╪╡╪з┘Ж╪з╪к (Side Effects):** ╪з╪│ ┌й█Т ┘Е┘Е┌й┘Ж█Б ╪│╪з╪ж█М┌И ╪з█М┘Б█М┌й┘╣╪│ ┌й█М╪з █Б█М┌║╪Я
  5. **╪╖╪▒█М┘В█Б ╪з╪│╪к╪╣┘Е╪з┘Д (Usage/Dosage):** ╪╣╪з┘Е ╪╖┘И╪▒ ┘╛╪▒ ╪з╪│█Т ┌й█М╪│█Т ╪з╪│╪к╪╣┘Е╪з┘Д ┌й█М╪з ╪м╪з╪к╪з █Б█Т╪Я
  6. **╪з╪н╪к█М╪з╪╖ (Precautions):** ┌й┘Ж ┘Д┘И┌п┘И┌║ ┌й┘И ╪з╪│╪к╪╣┘Е╪з┘Д ┘Ж█Б█М┌║ ┌й╪▒┘Ж█М ┌Ж╪з█Б█М█Т╪Я

  ╪м┘И╪з╪и ╪╡╪з┘Б ╪│╪к┌╛╪▒█М ╪з╪▒╪п┘И ┘Е█М┌║ ╪з┘И╪▒ ┘Д╪│┘╣ ┌й█М ╪┤┌й┘Д ┘Е█М┌║ █Б┘И█Ф
  `;
  return analyzeImageWithText(prompt, image);
};

export const scanDocument = async (image: string): Promise<string> => {
  const prompt = `
  ╪з╪│ ╪п╪│╪к╪з┘И█М╪▓ (Document/Report) ┌й┘И ┘╛┌С┌╛█М┌║█Ф █М█Б ╪╖╪и█М ╪▒┘╛┘И╪▒┘╣╪М ┘Ж╪│╪о█Б █М╪з ┌й┘И╪ж█М ╪к╪н╪▒█М╪▒ █Б┘И ╪│┌й╪к█М █Б█Т█Ф
  ╪з╪│ ┌й╪з ┘Е┌й┘Е┘Д ┘Е╪к┘Ж ╪з╪▒╪п┘И ┘Е█М┌║ ╪к╪▒╪м┘Е█Б ┌й╪▒ ┌й█Т ╪о┘Д╪з╪╡█Б ╪и█М╪з┘Ж ┌й╪▒█М┌║█Ф
  ╪з┌п╪▒ █М█Б ┘Е█М┌И█М┌й┘Д ╪▒┘╛┘И╪▒┘╣ █Б█Т ╪к┘И ┘Ж╪к╪з╪ж╪м ┌й┘И ╪в╪│╪з┘Ж ╪з╪▒╪п┘И ┘Е█М┌║ ╪│┘Е╪м┌╛╪з╪ж█М┌║█Ф
  `;
  return analyzeImageWithText(prompt, image);
};